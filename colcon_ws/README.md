# urop_sim
- [urop_sim](#urop_sim)
-[Introduction](#introduction)
- [Version](#version)
- [How to start simulation](#how-to-start-simulation)
- [How to add a new model](#how-to-add-a-new-model)
    - [Object](#object)
    - [Sensors](#sensors)
- [Using a new camera](#using-a-new-camera)
- [Point cloud](#point-cloud)
- [DVL](#dvl)
- [Git LFS](#git-lfs)
## Introduction
This project is an underwater simulation based on [Orca4](https://github.com/clydemcqueen/orca4). Many changes have been added to this project such as using Unreal model for seabed scanning task, switching the rov model to BlueROV2 Heavy, and adding sensors such as DVL and acoustic sensor. 
Underwater sensors (DVL and underwater cameras) are from [dave](https://github.com/IOES-Lab/dave)
## Version
This environment for this project is ROS2 Humble and Gazebo Harmonic.
## How to start simulation?
1. Compilation
```bash
cd ~/home/orca4/colcon_ws
colcon build
```        
It may take a few minutes to compile as the project size is large.     

2. Ways to launch simulation                           
There are two ways to launch simulation, you can either launch with [tmux](#tmux) or launch [one by one](#run_simulation).            
1. Tmux                
Launch simulation
```bash
chmod +x launch_sim.sh
./launch_sim.sh
```
To shutdown simulation, enter ```ctrl-c``` in the main session. Once the program shutdowns, enter ```ctrl-b``` first, then enter ```:kill-session```

1. Run_simulation

    1. 
    ```bash
    source src/orca4/setup.bash
    ros2 launch orca_bringup sim_launch.py
    ```                      
    2.   
    Open a new terminal outside the container
    ```bash
    docker exec -it orca4 bash
    . install/setup.bash
    ros2 run orca_bringup mission_runner.py
    ```  

## How to add a new model
There are two ways to deal with adding a new model.

### Object
1. Convert the model to ```.dae``` in Blender.

2. Create a package to hold model(s).
```bash
mkdir models
cd models
mkdir ust_seabed_1
mkdir ust_seabed_2
...
```

3. Package the model
```bash
cd ust_seabed_1
mkdir ust_seabed
cd ust_seabed
mkdir meshes
touch model.config
touch model.sdf
``` 
#### meshes
```meshes``` stores the mesh of the model generated by the model conversion.
#### model.config
```model.config``` is the metadata of the model.
#### model.sdf
```model.sdf``` is the structure of the model. It describes the structure of the model.
```xml
<sdf version="1.6">
    <model name="ust_seabed">
        <static>true</static>
        <link name="link">
            <visual name="visual">
                <geometry>
                    <mesh>
                        <uri>model://ust_seabed/meshes/ust_seabed.dae</uri>
                    </mesh>
                </geometry>
            </visual>
        </link>
    </model>
</sdf>
```
- static
Whether the model should be influenced by gravity.
### Sensors
The model structure of sensors is composed of link, joint and plugin.
#### link
```link``` contains the pose, sensor type, and collsion of the sensor.
#### joint
```joint``` connects the parent link and child link together. 
#### plugin
Most of the sensors require plugin to work together. Some plugins are come with the gz-sensor while some plugins are customized. You may need to put them in the workspace (acoustic sensor).

## Using a new camera
You may want to change the resolution of the camera. There are a few steps to follow.
1. Camera calibration
Please visit [camera_calibration](https://github.com/HKUST-UROP-ROV-SIM/gazebo_camera_calibration). Rember to save the camera parameters after doing calibration.
2. Update camera resolution
Go to [orca4](src/orca4/orca_description/models/orca4/model.sdf) and change the camera resolution.
```xml
         <width>3840</width>
            <height>1440</height>
```
3. Update camera parameters.
You can put the new camera parameters file at [cfg](src/orca4/orca_bringup/cfg/). 
To update the parameters, copy the parameters to [sim_left.ini](src/orca4/orca_bringup/cfg/sim_left.ini) and [sim_right.ini](src/orca4/orca_bringup/cfg/sim_right.ini). This step is compulsory as Slam relies on the camera parameters.
4. Update camera baseline
The camera baseline must be decimal number!!!    

Go to [sim_orca_params.yaml](src/orca4/orca_bringup/params/sim_orca_params.yaml) and update ```  camera_baseline: 823.74008  # Right camera info p[3], flip sign```
Formula
```
new base line = new camera width / 800 * 171
```

## point cloud
After doing seabed scanning, you may want to save the point cloud.  
Run:
```bash
ros2 service call /orb_slam2_stereo_node/save_map orb_slam2_ros/srv/SaveMap name:\ \'\'\ 
```

If you want to load the previously saved point cloud, in [sim_orca_params.yaml](src/orca4/orca_bringup/params/sim_orca_params.yaml), provide the directory of the point cloud file and set ```load_map``` to ```True```.
```yaml
map_file: "map.bin"
    # map_file: "/home/orca4/colcon_ws/4k_map.yaml"
    load_map: False
```

## DVL
The data of DVL is published to ```/dvl/velocity```.
Relevant information can be found [here](https://yeongdocat.notion.site/Custom-ros_gz-bridge-for-DVL-Plugin-39a621c52833475ea661dade2660350f).

[Gazebo Sim DVL sensor documentation](https://gazebosim.org/api/sensors/8/classgz_1_1sensors_1_1DopplerVelocityLog.html).  
There a some parameters need to be configured to mimic the real one (unit is degree)
- aperture
- rotation
- tilt
- bottom_mode
- water_mass_mode
- minimum_range
- maximum_range

Since the one used in real world is Water Linked DVL A50, the parameters are set to
- aperture
```
aperture = c / (f * d) = 1500 / (1 000 000 * 0.02) = 0.075 rad
0.075 rad = 0.075 * 180 / pi = 4.3 deg
c (sound travelling speed in water) : 1500 ms^-2
f (frequency)                       : 1 MHz
d (transducer diameter)             : 2cm
```
- rotation
The transducers are placed evenly and separated by 45 degree angles. 
- tilt
According to [BlueRobotics](https://bluerobotics.com/store/the-reef/dvl-a50/), the transducers are tilted at 15 degree angles.
- minimum_range
5 cm
- maximum_range
50 m

The above information is provided by [link](https://waterlinked.com/web/content/15701?unique=b4aef6d930bb256c64bae4e0ead8c56661bf12f0).

## Underwater camera
### Introduction
As Gazebo doesn't provide realistic underwater imagery for ROV simulation, underwater camera plugin is used to recreate the imagery. Underwater camera consists of rgbd_camera and UnderwaterCamera plugin. The plugin makes use of the camera image and visual parameters (attenuation and background) to simulate the image.   
Remarks: The plugin is only applicable to rgbd_camera.
### Topic
```/stereo_left/simulated_image``` and ```/stereo_right/simulated_image```
### Underwater camera config
- rgbd_camera resolution: 800 x 600
The use of low resolution camera is to avoid using up all memory.
- camera update rate
The update rate of the cameras is critical to the simulation result. If the rate is set more than 3, the ROV is out-of-control. By setting the rate <= 3, the problem is solved but it will have a negative effect to the mapping quality. This issue may link to the hardware equipment.
[Source](https://yeongdocat.notion.site/084db8b3a8f74adfbddf21ed92d445ed?v=757190b0ef6d4f51ba570a19300c9542&p=8aec0ec6d82c48beade703be379851c1&pm=s)
- parameters
     <plugin
          filename="UnderwaterCamera"
          name="dave_gz_sensor_plugins::UnderwaterCamera">
          <!-- Blurish color -->

       <attenuationR>0.1</attenuationR>
    <attenuationG>0.1</attenuationG>
    <attenuationB>0.05</attenuationB>
  <backgroundR>28</backgroundR>
    <backgroundG>107</backgroundG>
    <backgroundB>160</backgroundB>
    
    <!-- Murkey Costal Waters -->
      <!-- <attenuationR>0.8</attenuationR>
    <attenuationG>0.5</attenuationG>
    <attenuationB>0.2</attenuationB>
    <backgroundR>85</backgroundR>
    <backgroundG>107</backgroundG>
    <backgroundB>47</backgroundB> -->
        </plugin>
Blurish and greenish
```xml
<attenuationR>0.8</attenuationR>
<attenuationG>0.5</attenuationG>
<attenuationB>0.2</attenuationB>
<backgroundR>40</backgroundR>
<backgroundG>100</backgroundG>
<backgroundB>160</backgroundB>
```
## Git LFS
[Git LFS](https://git-lfs.com/) is used for tracking the larger-sized files such as the seabed model.   
